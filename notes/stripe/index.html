<!DOCTYPE html>
<html>

  <head>
    <!-- Standard Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


    <!-- Site Properties -->
    <title>Switchless</title>

    <link rel="stylesheet" href="/assets/sematic/semantic.min.css">
    <style type="text/css">

      .hidden.menu {
        display: none;
      }

      .masthead.segment {
        min-height: 500px;
        padding: 1em 0em;
      }
      .masthead .logo.item img {
        margin-right: 1em;
      }
      .masthead .ui.menu .ui.button {
        margin-left: 0.5em;
      }
      .masthead h1.ui.header {
        margin-top: 4em;
        margin-bottom: 0em;
        font-size: 3em;
        /*color:#3f3c3d;*/
        text-shadow: 0.04em 0.04em 0.04em rgba(0,0,0,0.25);
        font-weight: normal;
      }
      .masthead h2 {
        font-size: 1.7em;
        font-weight: normal;
      }

      .ui.vertical.stripe {
        padding: 5em 0em;
      }
      .ui.vertical.stripe h3 {
        font-size: 2em;
      }
      .ui.vertical.stripe .button + h3,
      .ui.vertical.stripe p + h3 {
        margin-top: 3em;
      }
      .ui.vertical.stripe .floated.image {
        clear: both;
      }
      .ui.vertical.stripe p {
        font-size: 1.33em;
      }
      .ui.vertical.stripe ul {
        font-size: 1.33em;
      }
      .ui.vertical.stripe li {
        line-height: 1.4285em;
      }
      .ui.vertical.stripe .horizontal.divider {
        margin: 3em 0em;
      }

      .quote.stripe.segment {
        padding: 0em;
      }
      .quote.stripe.segment .grid .column {
        padding-top: 5em;
        padding-bottom: 5em;
      }

      .footer.segment {
        padding: 5em 0em;
      }

      .secondary.pointing.menu .toc.item {
        display: none;
      }

      @media only screen and (max-width: 700px) {
        /*.ui.fixed.menu {
          display: none !important;
        }*/
        .secondary.pointing.menu .item,
        .secondary.pointing.menu .menu {
          display: none;
        }
        .secondary.pointing.menu .toc.item {
          display: block;
        }
        .masthead.segment {
          min-height: 350px;

        }
        .masthead h1.ui.header {
          font-size: 2em;
          margin-top: 1.5em;
        }
        .masthead h2 {
          margin-top: 0.5em;
          font-size: 1.5em;
        }
        .segment h2{
          color: #00296b;
        }
      }


    </style>
      <script src="/assets/jquery.min.js"></script>
      <script src="/assets/sematic/semantic.min.js"></script>
    <script>
    $(document)
      .ready(function() {


        // create sidebar and attach to menu open
        $('.ui.sidebar')
          .sidebar('attach events', '.toc.item')
        ;
        $('.ui.accordion').accordion();
        $('img').addClass('ui').addClass('image');
      })
    ;
    </script>

  </head>
  <body>
    
    <!-- Sidebar Menu -->
    <div class="ui vertical inverted sidebar menu">
      <a class="item" href='/'>About</a>
      <!-- <a class="item" href='/about/'>About</a> -->
      <a class="item" href='/Design%20patterns/'>Design patterns</a>
      <a class="item" href='/Stack%20components/'>Stack</a>
    </div>
    <!-- Page Contents -->
    <div class="pusher">
      <div class="ui large top fixed secondary pointing menu" style="background: rgba(255,255,255,1)">
        <div class="ui container" style="font-size: 16px">
          <a class="toc item">
            <i class="sidebar icon"></i>
          </a>
          <div class='center menu'>
            <a class="item" href='/'>About</a>
            <!-- <a class="item" href='/about/'>About</a> -->
            <a class="item" href='/Design%20patterns/'>Design patterns</a>
            <a class="item" href='/Stack%20components/'>Stack</a>

          </div>
          
        </div>
      </div>
      <!-- <div class="ui inverted vertical center aligned segment" style='background: #7cacda;'>
        <div class="ui container">
          <div class="ui large secondary inverted pointing menu">
            <a class="toc item">
              <i class="sidebar icon"></i>
            </a>
            <div class="right item">
              <a class="ui inverted button" href='/login'>Log in</a>
              &nbsp;
              <a class="ui inverted button" href="/getting_started">Get Started</a>
            </div>
          </div>
        </div>
      </div> -->
      Switchless
      TEST
      <br>
<br>
<br>
<div class='ui container'>
	
	<div class='ui centered stackable grid'>
		<div class='three wide computer only column'>
			<img src="/assets/switchless_docs_logo.png" class='ui image'>
		</div>
		<div class='ten wide large screen twelve wide computer forteen wide tablet column'>
			<div class='ui basic segment' style="font-size: 18px;line-height: 1.5em">
				<h1>Stripe Integration</h1>
<hr>
<p>author: #anzal</p>
<hr>
<h3>Which stripe integration is best for Indian Merchants?</h3>
<ul>
<li>Stripe Save and Reuse
<ul>
<li>This method save cards for future payments</li>
</ul>
</li>
</ul>
<p>Reference: https://stripe.com/docs/payments/save-and-reuse?platform=web</p>
<h2>Integration details</h2>
<h3>UI</h3>
<ol>
<li>Add or choose a card
<img src="/files/Pasted image 20210521154316.png"></img>
Here's the style used: <a href="/notes/styling stripe">styling stripe</a></li>
</ol>
<p>Requirements:</p>
<ul>
<li><code>client_secret</code> - we get this by creating an intent to setup a card. Check 'backend' section below for details</li>
</ul>
<pre><code class="language-html">
&lt;div class=&quot;ui  &quot;&gt;

  &lt;div class=&quot;sr-root&quot;&gt;
    &lt;div class=&quot;sr-main&quot;&gt;
      &lt;%if(saved_cards&amp;&amp;saved_cards.length&gt;0){%&gt;
      &lt;div class=&quot;ui segments&quot;&gt;
        &lt;% saved_cards.forEach(function(card){%&gt;
          &lt;form class=&quot;ui form segment&quot; method=&quot;POST&quot; action=&quot;/api/{{estimate_for_payment_id}}/payment/stripe/pay_with_stripe_payment_method&quot;&gt;
            &lt;div class=&quot;ui &quot;&gt;
              &lt;b&gt;
              &lt;%=_.capitalize(card.card.brand) %&gt; &lt;%=_.capitalize(card.card.funding)%&gt; Card &lt;/b&gt; ending in &lt;%=card.card.last4%&gt; expires on &lt;%=card.card.exp_month%&gt;/&lt;%=card.card.exp_year%&gt;
            &lt;/div&gt;

            &lt;button class=&quot;ui   green button &quot; type=&quot;submit&quot; style=&quot;float: right;&quot;&gt;Pay&lt;/button&gt;
            &lt;br&gt;
            &lt;br&gt;
            &lt;input name=&quot;payment_method_id&quot; value=&quot;&lt;%=card.id%&gt;&quot; hidden&gt;
          &lt;/form&gt;
          &lt;%}) %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;ui horizontal divider&quot;&gt;OR&lt;/div&gt;
      &lt;%}else{%&gt;
        &lt;br&gt;
        &lt;div class=&quot;ui segment&quot;&gt;
          &lt;span&gt;You don't have any saved cards&lt;/span&gt;
          &lt;br&gt;  &lt;/div&gt;

        &lt;br&gt;

      &lt;%}%&gt;
      &lt;form id=&quot;setup-form&quot; data-secret=&quot;&lt;%=client_secret%&gt;&quot; &gt;
        &lt;h3&gt;Link a new card&lt;/h3&gt;
        &lt;!-- &lt;div class=&quot;sr-form-row&quot;&gt;
          &lt;label&gt;
            Account details
          &lt;/label&gt;
          &lt;input type=&quot;text&quot; id=&quot;email&quot; placeholder=&quot;name&quot; /&gt;
        &lt;/div&gt; --&gt;
        &lt;input type=&quot;text&quot; id=&quot;email&quot; placeholder=&quot;Email address&quot; style=&quot;border-color: white;&quot;  /&gt;

        &lt;div class=&quot;sr-form-row&quot;&gt;
          &lt;label&gt;

          &lt;/label&gt;
          &lt;!-- &lt;div class=&quot;sr-input sr-element sr-card-element&quot; id=&quot;card-element&quot;&gt; --&gt;
          &lt;div class=&quot;&quot; id=&quot;card-element&quot; style=&quot;background-color: white;padding:1em;&quot;&gt;
            &lt;!-- A Stripe card Element will be inserted here. --&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;sr-field-error&quot; id=&quot;card-errors&quot; role=&quot;alert&quot;&gt;&lt;/div&gt;
        &lt;button id=&quot;submit&quot; class=&quot;ui basic blue fluid button&quot;&gt;
          &lt;div class=&quot;spinner hidden&quot; id=&quot;spinner&quot;&gt;&lt;/div&gt;
          &lt;span id=&quot;button-text&quot;&gt;Link your card to your account&lt;/span&gt;
        &lt;/button&gt;
      &lt;/form&gt;

      &lt;form class=&quot;ui new_card_created form segment&quot; method=&quot;POST&quot; action=&quot;/api/{{estimate_for_payment_id}}/payment/stripe/pay_with_stripe_payment_method&lt;%=(req.url.search('new_user_pay')!=-1)?'?new_user_pay=true':''%&gt;&quot; style=&quot;display: none;&quot;&gt;
        &lt;input name=&quot;payment_method_id&quot; id=&quot;new_card_payment_id&quot; value=&quot;&quot; hidden&gt;
      &lt;/form&gt;
      &lt;div class=&quot;sr-result hidden&quot;&gt;
        &lt;p&gt;Card setup completed&lt;br /&gt;&lt;/p&gt;

      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;





&lt;script src=&quot;https://js.stripe.com/v3/&quot;&gt;&lt;/script&gt;
&lt;script&gt;
   $('.button[type=&quot;submit&quot;]').click(function(){
          $(this).addClass('loading');
          $(this).addClass('disabled');
    })

  var stripe = Stripe('&lt;%=sails.config.stripe.pk_secret%&gt;');


  // Element styles
  var elements = stripe.elements();
  var card = elements.create('card');
  card.mount('#card-element');

  
  // Handle payment submission when user clicks the pay button.
  var button = document.getElementById(&quot;submit&quot;);
  button.addEventListener(&quot;click&quot;, function(event) {
    event.preventDefault();
    changeLoadingState(true);
    var email = document.getElementById(&quot;email&quot;).value;

    stripe
      .confirmCardSetup('&lt;%=client_secret%&gt;',
      {
        payment_method: {
          card: card,
          billing_details: { email: email }
        }
      })
      .then(function(result) {
        console.log(result)
        if (result.error) {
          changeLoadingState(false);
          var displayError = document.getElementById(&quot;card-errors&quot;);
          displayError.textContent = result.error.message;
        } else {
          // The PaymentMethod was successfully set up
          orderComplete(stripe, '&lt;%=client_secret%&gt;');
        }
      });
  });




// Show a spinner on payment submission
var changeLoadingState = function(isLoading) {
  if (isLoading) {
    document.querySelector(&quot;button&quot;).disabled = true;
    document.querySelector(&quot;#spinner&quot;).classList.remove(&quot;hidden&quot;);
    document.querySelector(&quot;#button-text&quot;).classList.add(&quot;hidden&quot;);
  } else {
    document.querySelector(&quot;button&quot;).disabled = false;
    document.querySelector(&quot;#spinner&quot;).classList.add(&quot;hidden&quot;);
    document.querySelector(&quot;#button-text&quot;).classList.remove(&quot;hidden&quot;);
  }
};

/* Shows a success / error message when the payment is complete */
var orderComplete = function(stripe, clientSecret) {
  stripe.retrieveSetupIntent(clientSecret).then(function(result) {
    var setupIntent = result.setupIntent;
    var setupIntentJson = JSON.stringify(setupIntent, null, 2);


    document.querySelector(&quot;.sr-result&quot;).classList.remove(&quot;hidden&quot;);

    setTimeout(function() {
      document.querySelector(&quot;.sr-result&quot;).classList.add(&quot;expand&quot;);
    }, 200);

    changeLoadingState(false);
    $('#new_card_payment_id').val(setupIntent.payment_method)
    $('.new_card_created').submit()
  });
};


&lt;/script&gt;

</code></pre>
<h3>Backend</h3>
<ol>
<li>Create customer and store</li>
</ol>
<pre><code>stripe.customers.create({
  name: org.owner.name,
  email: org.owner.email,
  address: {
	line1: `${org.name},${org.country}`,
	country: `${sails.config.countries.find(country =&gt; country.name == org.country).code || 'US'}`,
  }
}).then(function (customer) {
  var org_details = org.details || {}
  _.set(org_details, 'thirdparty_accounts.stripe_customer', customer)
  Org.updateOne({ id: org.id }).set({ details: org_details }).exec(function (err, org) { })
  callback(null, customer)
})
</code></pre>
<ol start="2">
<li>Create card setup intent
Use this when customer wants to setup a new card</li>
</ol>
<pre><code>  stripe.setupIntents.create({
	customer: results.findOrgCreateStripeCustomer.id,
  }).then(function (intent) {
	callback(null, intent)
  })
</code></pre>
<ol start="3">
<li>Fetch saved cards</li>
</ol>
<pre><code>  stripe.paymentMethods.list({
	customer: results.findOrgCreateStripeCustomer.id,
	type: 'card',
  }).then(function (saved_cards) {
	callback(null, saved_cards)
  })
</code></pre>
<ol start="4">
<li>Charge a saved card</li>
</ol>
<pre><code>stripe.paymentIntents.create({
	amount: amount,
	currency: currency,
	customer: results.findOrgCreateStripeCustomer.id,
	payment_method: payment_method_id,
	off_session: true, //this lets you charge without customer being on session
	confirm: true,
	description: 'VA service',
  }).then(function (intent) {
	if (intent.status == 'succeeded') {
			res.redirect(`/api/v1/estimate/${estimate.id}/payment/stripe/capture_saved_card_payment?intent_id=${intent.id}`)

	} else {
	  console.log(results)
	  res.send('payment failed')
	}
  })
</code></pre>
<ol start="5">
<li>Authorize payment received
Fetch the payment intent and confirm if the payment is received</li>
</ol>
<pre><code>async function authorizeStripePaymentIntentAndGetPaymentDetails(paymentIntentID, callback) {
  if (!paymentIntentID) return callback(new Error(&quot;Invalid params, 'paymentIntentID' is mandatory&quot;));
  const pg_response = await stripe.paymentIntents.retrieve(paymentIntentID);
  if (!pg_response || _.isEmpty(pg_response)) {
    callback(new Error(`Payment Details not found for sessionID: ${paymentIntentID}`));
  } else if (pg_response.status != 'succeeded') {
    callback(pg_response.status);
  } else {
    //paid
    callback(null, pg_response);
  }

}
</code></pre>

			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	if(window.location.pathname.indexOf('/blog/')>-1){
		$('a[href="/blog/"]').addClass('active');
	}
</script>
    </div>




    <!--
        Client-side Templates
        ========================

        HTML templates are important prerequisites of modern, rich client applications.
        To work their magic, frameworks like React, Vue.js, Angular, Ember, and Backbone
        require that you load these templates client-side.

        By default, your Gruntfile is configured to automatically load and precompile
        client-side JST templates in your `assets/templates` folder, then
        include them here automatically (between TEMPLATES and TEMPLATES END).

        To customize this behavior to fit your needs, just edit `tasks/pipeline.js`.
        For example, here are a few things you could do:

            + Import templates from other directories
            + Use a different view engine (handlebars, dust, pug/jade, etc.)
            + Internationalize your client-side templates using a server-side
              stringfile before they're served.
    -->

    <!--TEMPLATES-->
    <!--TEMPLATES END-->


    <!--
        Server-side View Locals
        ========================

        Sometimes, it's convenient to get access to your server-side view locals from
        client-side JavaScript.  This can improve page load times, remove the need for
        extra AJAX requests, and make your client-side code easier to understand and
        to maintain.  Sails provides a simple mechanism for accessing dynamic view
        locals: the "exposeLocalsToBrowser()" view partial.

        For more information on using this built-in feature, see:
        https://sailsjs.com/docs/concepts/views/locals#?escaping-untrusted-data-using-exposelocalstobrowser

    -->


    <!--

      Client-side Javascript
      ========================

      You can always bring in JS files manually with `script` tags, or asynchronously
      on the client using a solution like AMD (RequireJS).  Or, if you like, you can
      take advantage of Sails' conventional asset pipeline (boilerplate Gruntfile).

      By default, files in your `assets/js` folder are included here
      automatically (between SCRIPTS and SCRIPTS END).  Both JavaScript (.js) and
      CoffeeScript (.coffee) are supported. In production, your scripts will be minified
      and concatenated into a single file.

      To customize any part of the built-in behavior, just edit `tasks/pipeline.js`.
      For example, here are a few things you could do:

          + Change the order of your scripts
          + Import scripts from other directories
          + Use a different preprocessor, like TypeScript

    -->


    <script src="/assets/sails.io.js"></script>
    <script src="/assets/jquery.min.js"></script>
    <script src="/assets/sematic/semantic.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function(){
        var path = window.location.pathname;
        console.log(path.split('/'));
        
        $('a[href="'+path+'"]').addClass('active');
        $('.dropdown').dropdown();
        // if(path.split('/')[1]=='features')
        //   $('#features').addClass('active');
        // $('.click-sidebar').click(function(){
        //   $('.ui.sidebar').sidebar('toggle');
        // })
        // $('.inline.dropdown').dropdown();
      });
    </script>
  </body>
</html>