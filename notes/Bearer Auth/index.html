<!DOCTYPE html>
<html>

  <head>
    <!-- Standard Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


    <!-- Site Properties -->
    <title>Switchless</title>

    <link rel="stylesheet" href="/assets/sematic/semantic.min.css">
    <style type="text/css">

      .hidden.menu {
        display: none;
      }

      .masthead.segment {
        min-height: 500px;
        padding: 1em 0em;
      }
      .masthead .logo.item img {
        margin-right: 1em;
      }
      .masthead .ui.menu .ui.button {
        margin-left: 0.5em;
      }
      .masthead h1.ui.header {
        margin-top: 4em;
        margin-bottom: 0em;
        font-size: 3em;
        /*color:#3f3c3d;*/
        text-shadow: 0.04em 0.04em 0.04em rgba(0,0,0,0.25);
        font-weight: normal;
      }
      .masthead h2 {
        font-size: 1.7em;
        font-weight: normal;
      }

      .ui.vertical.stripe {
        padding: 5em 0em;
      }
      .ui.vertical.stripe h3 {
        font-size: 2em;
      }
      .ui.vertical.stripe .button + h3,
      .ui.vertical.stripe p + h3 {
        margin-top: 3em;
      }
      .ui.vertical.stripe .floated.image {
        clear: both;
      }
      .ui.vertical.stripe p {
        font-size: 1.33em;
      }
      .ui.vertical.stripe ul {
        font-size: 1.33em;
      }
      .ui.vertical.stripe li {
        line-height: 1.4285em;
      }
      .ui.vertical.stripe .horizontal.divider {
        margin: 3em 0em;
      }

      .quote.stripe.segment {
        padding: 0em;
      }
      .quote.stripe.segment .grid .column {
        padding-top: 5em;
        padding-bottom: 5em;
      }

      .footer.segment {
        padding: 5em 0em;
      }

      .secondary.pointing.menu .toc.item {
        display: none;
      }

      @media only screen and (max-width: 700px) {
        /*.ui.fixed.menu {
          display: none !important;
        }*/
        .secondary.pointing.menu .item,
        .secondary.pointing.menu .menu {
          display: none;
        }
        .secondary.pointing.menu .toc.item {
          display: block;
        }
        .masthead.segment {
          min-height: 350px;

        }
        .masthead h1.ui.header {
          font-size: 2em;
          margin-top: 1.5em;
        }
        .masthead h2 {
          margin-top: 0.5em;
          font-size: 1.5em;
        }
        .segment h2{
          color: #00296b;
        }
      }


    </style>
      <script src="/assets/jquery.min.js"></script>
      <script src="/assets/sematic/semantic.min.js"></script>
    <script>
    $(document)
      .ready(function() {


        // create sidebar and attach to menu open
        $('.ui.sidebar')
          .sidebar('attach events', '.toc.item')
        ;
        $('.ui.accordion').accordion();
        $('img').addClass('ui').addClass('image');
      })
    ;
    </script>

  </head>
  <body>
    
    <!-- Sidebar Menu -->
    <div class="ui vertical inverted sidebar menu">
      <a class="item" href='/'>About</a>
      <!-- <a class="item" href='/about/'>About</a> -->
      <a class="item" href='/Design%20patterns/'>Design patterns</a>
      <a class="item" href='/Stack%20components/'>Stack</a>
    </div>
    <!-- Page Contents -->
    <div class="pusher">
      <div class="ui large top fixed secondary pointing menu" style="background: rgba(255,255,255,1)">
        <div class="ui container" style="font-size: 16px">
          <a class="toc item">
            <i class="sidebar icon"></i>
          </a>
          <div class='center menu'>
            <a class="item" href='/'>About</a>
            <!-- <a class="item" href='/about/'>About</a> -->
            <a class="item" href='/Design%20patterns/'>Design patterns</a>
            <a class="item" href='/Stack%20components/'>Stack</a>

          </div>
          
        </div>
      </div>
      <!-- <div class="ui inverted vertical center aligned segment" style='background: #7cacda;'>
        <div class="ui container">
          <div class="ui large secondary inverted pointing menu">
            <a class="toc item">
              <i class="sidebar icon"></i>
            </a>
            <div class="right item">
              <a class="ui inverted button" href='/login'>Log in</a>
              &nbsp;
              <a class="ui inverted button" href="/getting_started">Get Started</a>
            </div>
          </div>
        </div>
      </div> -->
      Switchless
      TEST
      <br>
<br>
<br>
<div class='ui container'>
	
	<div class='ui centered stackable grid'>
		<div class='three wide computer only column'>
			<img src="/assets/switchless_docs_logo.png" class='ui image'>
		</div>
		<div class='ten wide large screen twelve wide computer forteen wide tablet column'>
			<div class='ui basic segment' style="font-size: 18px;line-height: 1.5em">
				<h1>Bearer Auth</h1>
<hr>
<ul>
<li>keywords: #pattern</li>
<li>author: #alex</li>
</ul>
<hr>
<p>We use this for user based access to backend apis. This auth can be applied to both blueprint APIs and well as custom APIs.</p>
<p>The bearer token that we use is in fact a JWT token. The following are the features supposed by Bearer JWT Auth:</p>
<ul>
<li>Aiblity to verify tokens with secret using JWT</li>
<li>Abilty to create user specific tokens that only has access to resources that the user can access.</li>
<li>Ability to invalidate past tokens</li>
</ul>
<h2>Setup</h2>
<p><strong>1) Install these packages:</strong></p>
<pre><code class="language-js">passport-http-bearer
sails-hook-organics

</code></pre>
<ol start="2">
<li>Add this controller to Auth controller</li>
</ol>
<pre><code class="language-js">appLogin:function(req,res){
    if(!req.body.email)
        return res.badRequest('you need to specify email');
    if(!req.body.password)
        return res.badRequest('you need to specify password');
    User.findOne({ email: req.body.email }, function (err, user) {
        if (err) 
            throw err;
        if (!user)
            return res.status(401).json({ message: 'Incorrect email.' });

        bcrypt.compare(req.body.password, user.password, function (err, result) {
            if (!result)
                return res.status(401).json({message: 'Invalid Password'});
            var uuid = sails.helpers.strings.uuid();
            var token = jwt.sign({ id: user.id, uuid: uuid }, sails.config.api_jwt_secret);
            var details = user.details;
            if(!details.api)
                details.api={};
            if(!details.api.valid_uuids)
                details.api.valid_uuids=[];
            details.api.valid_uuids.push(uuid);
            User.updateOne({id:user.id},{details:details}).exec(function(err,result){
                res.send({token:token});
            })
        });
    });
},
</code></pre>
<ol start="3">
<li>Add this to <code>PassportService.js</code></li>
</ol>
<pre><code>var BearerStrategy = require('passport-http-bearer').Strategy;
const jwt = require('jsonwebtoken'); 


/**
 * api token strategy.
 */
passport.use(new BearerStrategy(
    function (api_token, done) {
        jwt.verify(api_token, sails.config.api_jwt_secret, function (err, jwt_decode_payload) {
            if (err) return done(err);
            
            User.findOne(jwt_decode_payload.id).exec(function (err, user) {
                if (err) return done(err);

                if (!user) return done('user not found');

                //check for the uuid of the token with database
                var valid_uuids=_.get(user,'details.api.valid_uuids',[]);
                if (!valid_uuids.includes(jwt_decode_payload.uuid))
                    return done('your token is not part of acceptable tokens associated with this user.');

                // set the scope for the policy to indentify a blueprint request.
                return done(null, user, { scope: 'blueprint' });
            })
        })
    }
));
</code></pre>
<ol start="4">
<li>Modify <code>http.js</code></li>
</ol>
<pre><code class="language-js">// modify http.order to the following
order: [
    'cookieParser',
    'session',
    'passportInit',     
    'passportSession',
    'authenticateBearer', // this is newly added
    'bodyParser',
    'myRequestLogger',
    'handleBodyParserError',
    'compress',
    'methodOverride',
    'poweredBy',
    'router',
    'www',
    'favicon',
    '404',
    '500'
],

// add this to http.middlewear
authenticateBearer: function (req, res, next) {
    // authenticate apis with bearer token

    if(req.headers.authorization &amp;&amp; req.headers.authorization.startsWith('Bearer'))
        require('passport').authenticate('bearer', { session: false })(req, res, function(err){
            if(err){
                // console.log('Error while authenticating using Bearer token');
                // console.log(err);
                var myRequestLogger =require('@switchless-io/util').middleware.requestLogger;
                myRequestLogger(req,res,function(some_err){ // this will log the item to logger
                    return res.status(401).send(err);
                })
            }else{
                next();
            }
        });
    else
        next()
},

</code></pre>
<ol start="5">
<li>create a new policy - <code>isAuthenticatedViaAPI</code></li>
</ol>
<pre><code class="language-js">module.exports = function(req, res, next) {
   if (req.isAuthenticated()) {
        return next();
    }
    else{
        return res.status(401).send('Use JWT Bearer token to authneticated yourself');
    }
};
</code></pre>
<p>This will check if the user is authenticated and send an appropriate error.</p>
<ol start="6">
<li>Create a new policy - <code>canAccessThisOrgViaAPI</code></li>
</ol>
<pre><code class="language-js">var async= require('async');
module.exports = function (req, res, next) {
    console.log(req.params);
    
     if (_.includes(sails.config.admins, req.user.email)) 
         return next();
    async.auto({
        // get all orgs that the user is part of
        getAllAccess:function(callback){
            Access.find({user:req.user.id}).exec(callback);
        }
    },function(err,results){
        var orgs=_.map(results.getAllAccess,'org');
        req.query.org=orgs;
        next(err);
    })
        
};
</code></pre>
<p>This policy is what you can modify to restrict access to resources based on user previlages. In this policy, if the user is an admin, then she will have access to all devices. Any other user will have only access to devices in the same org. This is done by setting req.query.org to orgs that the user is part of.</p>
<ol start="7">
<li>Modify <code>policies.js</code></li>
</ol>
<pre><code class="language-js">    APIController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
    UserController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
    OrgController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
    DeviceController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
    SiteController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
    MetricController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
    DispenseController:{
        '*':['isAuthenticatedViaAPI','canAccessThisOrgViaAPI'],
    },
</code></pre>
<p>Apply all these 2 policies to Controllers that matter to you.</p>
<ol start="8">
<li>Add this to <code>routes.js</code></li>
</ol>
<pre><code>'POST /app_login': 'AuthController.appLogin',
</code></pre>
<ol start="9">
<li>Modify your environment variables - <code>development.js</code> &amp; <code>production.js</code></li>
</ol>
<h2>Usage</h2>
<p>Make a <code>POST</code> request to <code>/api_login</code> to get the Bearer token.</p>
<p>Include the Bearer token in the authorisation header.</p>
<pre><code>Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6NCwidXVpZCI6ImMwNGM1YmZmLWFhNGYtNGU2OC1iNjk1LWI1ZWZmZmVlNjNjZCIsImlhdCI6MTU5NjU0NDIyOH0.Y42sktgmJ8PqTxx1KhlStXWU-orzy7Ia0ZQXiZt6aV0
</code></pre>

			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	if(window.location.pathname.indexOf('/blog/')>-1){
		$('a[href="/blog/"]').addClass('active');
	}
</script>
    </div>




    <!--
        Client-side Templates
        ========================

        HTML templates are important prerequisites of modern, rich client applications.
        To work their magic, frameworks like React, Vue.js, Angular, Ember, and Backbone
        require that you load these templates client-side.

        By default, your Gruntfile is configured to automatically load and precompile
        client-side JST templates in your `assets/templates` folder, then
        include them here automatically (between TEMPLATES and TEMPLATES END).

        To customize this behavior to fit your needs, just edit `tasks/pipeline.js`.
        For example, here are a few things you could do:

            + Import templates from other directories
            + Use a different view engine (handlebars, dust, pug/jade, etc.)
            + Internationalize your client-side templates using a server-side
              stringfile before they're served.
    -->

    <!--TEMPLATES-->
    <!--TEMPLATES END-->


    <!--
        Server-side View Locals
        ========================

        Sometimes, it's convenient to get access to your server-side view locals from
        client-side JavaScript.  This can improve page load times, remove the need for
        extra AJAX requests, and make your client-side code easier to understand and
        to maintain.  Sails provides a simple mechanism for accessing dynamic view
        locals: the "exposeLocalsToBrowser()" view partial.

        For more information on using this built-in feature, see:
        https://sailsjs.com/docs/concepts/views/locals#?escaping-untrusted-data-using-exposelocalstobrowser

    -->


    <!--

      Client-side Javascript
      ========================

      You can always bring in JS files manually with `script` tags, or asynchronously
      on the client using a solution like AMD (RequireJS).  Or, if you like, you can
      take advantage of Sails' conventional asset pipeline (boilerplate Gruntfile).

      By default, files in your `assets/js` folder are included here
      automatically (between SCRIPTS and SCRIPTS END).  Both JavaScript (.js) and
      CoffeeScript (.coffee) are supported. In production, your scripts will be minified
      and concatenated into a single file.

      To customize any part of the built-in behavior, just edit `tasks/pipeline.js`.
      For example, here are a few things you could do:

          + Change the order of your scripts
          + Import scripts from other directories
          + Use a different preprocessor, like TypeScript

    -->


    <script src="/assets/sails.io.js"></script>
    <script src="/assets/jquery.min.js"></script>
    <script src="/assets/sematic/semantic.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function(){
        var path = window.location.pathname;
        console.log(path.split('/'));
        
        $('a[href="'+path+'"]').addClass('active');
        $('.dropdown').dropdown();
        // if(path.split('/')[1]=='features')
        //   $('#features').addClass('active');
        // $('.click-sidebar').click(function(){
        //   $('.ui.sidebar').sidebar('toggle');
        // })
        // $('.inline.dropdown').dropdown();
      });
    </script>
  </body>
</html>